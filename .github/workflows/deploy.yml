name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:

env:
  GO_VERSION: 1.23
  TERRAFORM_VERSION: 1.12.2

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Download dependencies
      run: make setup

    - name: Run tests
      run: make test

    - name: Build function
      run: make build-linux

    - name: Create Terraform variables file
      run: |
        cat > terraform/terraform.tfvars << EOF
        project_id = "${{ secrets.GCP_PROJECT_ID }}"
        github_token = "${{ secrets.GH_WORKFLOW_TOKEN }}"
        repo_owner = "${{ github.repository_owner }}"
        repo_name = "${{ secrets.GH_TARGET_REPO_NAME }}"
        environment = "production"
        EOF

    - name: Terraform Init
      run: |
        # Calculate bucket name same way as in main.tf
        PROJECT_SANITIZED=$(echo "${{ secrets.GCP_PROJECT_ID }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
        BUCKET_NAME="gcs-${PROJECT_SANITIZED}-youtube-webhook-source"
        
        terraform -chdir=terraform init \
          -backend-config="bucket=${BUCKET_NAME}"

    - name: Import existing resources
      run: |
        # Calculate resource identifiers
        PROJECT_SANITIZED=$(echo "${{ secrets.GCP_PROJECT_ID }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
        BUCKET_NAME="gcs-${PROJECT_SANITIZED}-youtube-webhook-source"
        SA_NAME="yt-webhook-production-2dfc5d65"
        FUNCTION_NAME="youtube-webhook-production"
        
        # Check and import resources only if not already in state
        
        # Import bucket if it exists and not in state
        if ! terraform -chdir=terraform state show google_storage_bucket.function_source >/dev/null 2>&1; then
          echo "Importing storage bucket..."
          terraform -chdir=terraform import google_storage_bucket.function_source "${BUCKET_NAME}" || true
        else
          echo "Storage bucket already in state"
        fi
        
        # Import service account if it exists and not in state
        if ! terraform -chdir=terraform state show google_service_account.function_sa >/dev/null 2>&1; then
          echo "Importing service account..."
          terraform -chdir=terraform import google_service_account.function_sa "projects/${{ secrets.GCP_PROJECT_ID }}/serviceAccounts/${SA_NAME}@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com" || true
        else
          echo "Service account already in state"
        fi
        
        # Import Cloud Function if it exists and not in state
        if ! terraform -chdir=terraform state show google_cloudfunctions2_function.youtube_webhook >/dev/null 2>&1; then
          echo "Importing Cloud Function..."
          terraform -chdir=terraform import google_cloudfunctions2_function.youtube_webhook "projects/${{ secrets.GCP_PROJECT_ID }}/locations/us-central1/functions/${FUNCTION_NAME}" || true
        else
          echo "Cloud Function already in state"
        fi

    - name: Terraform Plan
      run: terraform -chdir=terraform plan -out=tfplan

    - name: Terraform Apply
      run: terraform -chdir=terraform apply tfplan

    - name: Get function URL
      id: function-url
      run: |
        # Get the URL and clean any debug output from Terraform wrapper
        RAW_OUTPUT=$(terraform -chdir=terraform output -raw webhook_url)
        URL=$(echo "$RAW_OUTPUT" | grep -o 'https://[^:]*' | head -n1)
        echo "Function URL: $URL"
        echo "url=$URL" >> $GITHUB_OUTPUT

    - name: Test deployed function
      run: |
        echo "Testing deployed function..."
        # Test function availability (non-blocking)
        if curl -f "${{ steps.function-url.outputs.url }}?hub.challenge=test-challenge&hub.mode=subscribe&hub.topic=test"; then
          echo "‚úÖ Function test successful"
        else
          echo "‚ÑπÔ∏è  Function test returned error (expected for authenticated endpoints)"
          echo "üì° Function is deployed and reachable at: ${{ steps.function-url.outputs.url }}"
        fi

    - name: Deployment summary
      run: |
        echo "üöÄ Production deployment successful!"
        echo "Function URL: ${{ steps.function-url.outputs.url }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"